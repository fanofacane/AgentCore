## 现状与问题定位

* 当前删除入口是 [RagQaDatasetController.deleteDataset](file:///d:/software/AgentCore/src/main/java/com/sky/AgentCore/controller/rag/RagQaDatasetController.java#L44-L52) → [RagQaDatasetAppService.deleteDataset](file:///d:/software/AgentCore/src/main/java/com/sky/AgentCore/service/rag/service/manager/RagQaDatasetAppService.java#L145-L182)。

* 该方法只调用了 [UserRagDomainService.forceUninstallRagByOriginalId](file:///d:/software/AgentCore/src/main/java/com/sky/AgentCore/service/rag/domain/UserRagDomainService.java#L369-L378)，它按 userId + originalRagId 删除，因此只删“创建者自己”的 `user_rags` 记录，其他用户的安装记录仍然保留。

* 同时，`forceUninstallRagByOriginalId` 不会触发快照清理逻辑；而快照数据在 [UserRagSnapshotDomainService](file:///d:/software/AgentCore/src/main/java/com/sky/AgentCore/service/rag/domain/UserRagSnapshotDomainService.java#L126-L143) 中，必须按 userRagId 删除 `user_rag_files` / `user_rag_documents`。

* 结果：数据集被删除后，仍有用户保留 `user_rags` / 快照表数据，导致“仍能使用/仍可见”的脏数据风险。

## 目标

* 删除数据集后，任何用户都不能再通过 `user_ragId` 或 `originalRagId` 使用该数据集。

* 关联数据清理至少覆盖：

  * 所有用户的 `user_rags`

  * 所有用户的安装快照：`user_rag_files`、`user_rag_documents`

  * 数据集版本及其快照：`rag_versions`、`rag_version_files`、`rag_version_documents`（现有代码已覆盖）

## 改造方案（代码层）

### 1) 新增“按数据集ID清理所有用户安装”的领域能力

* 在 `UserRagDomainService` 新增一个方法：

  * 输入：originalRagId

  * 行为：查询出所有 `user_rags`（不限定 userId）；对每条记录：

    * 若 installType == SNAPSHOT：调用 `UserRagSnapshotDomainService.deleteUserSnapshot(userRagId)` 清理 `user_rag_files`/`user_rag_documents`

    * 最后批量删除这些 `user_rags` 记录（按 originalRagId 条件）

  * 设计要点：删除 0 行不应抛异常（用于幂等删除），避免现在靠 try/catch 吃掉 checkedDelete 的异常。

### 2) 调整 deleteDataset 逻辑为“先全量卸载→再删版本→再删数据集资源”

* 在 [RagQaDatasetAppService.deleteDataset](file:///d:/software/AgentCore/src/main/java/com/sky/AgentCore/service/rag/service/manager/RagQaDatasetAppService.java#L145-L182) 中：

  * 用“全量卸载”替换当前“仅卸载创建者自己”的逻辑

  * 保持整体事务 `@Transactional`，确保卸载/版本删除/数据集删除一致性

  * 删除顺序建议：

    1. 清理所有用户安装（user\_rags + user\_rag\_\*）
    2. 删除所有发布版本（rag\_versions + rag\_version\_\*）
    3. 删除数据集下资源/记录（文件、语料、向量等）
    4. 删除数据集本体

### 3) （建议一并修复）补齐“数据集下文件/语料/向量”的清理

* 我在排查时发现 [FileDetailDomainService.deleteAllFilesByDataset](file:///d:/software/AgentCore/src/main/java/com/sky/AgentCore/service/rag/domain/FileDetailDomainService.java#L195-L212) 目前仅删除对象存储文件，并未删除 `file_detail` 记录，也未清理 `document_unit` 与向量库。

* 为了满足“删除干净”，建议在 deleteDataset 中增加：

  * 拉取 datasetId 下的 fileId 列表

  * 删除对应 `document_unit`（可用 `DocumentUnitDomainService.listDocumentsByFile` + `batchDeleteDocumentUnits`）

  * 调用 `EmbeddingDomainService.deleteEmbedding(fileIds)` 清理向量库

  * 删除 `file_detail` 记录（新增 domain 方法或 mapper wrapper 删除）

  * 再删除对象存储文件（现有逻辑可复用）

## 验证方式

* 增加/完善一个服务层测试（或集成测试）：

  * 构造：一个数据集、两位用户的 `user_rags`（含 SNAPSHOT + REFERENCE）、以及对应 `user_rag_files/user_rag_documents`

  * 调用 deleteDataset 后断言：

    * `user_rags` 中 originalRagId=datasetId 的记录为 0

    * `user_rag_files/user_rag_documents` 中关联 userRagId 的记录为 0

    * 版本表与快照表记录为 0

    * （若启用第3点）file\_detail / document\_unit / 向量库对应数据也被清理

## 影响面评估

* 对外 API 不变，仅修复删除的“完整性”和“不可再使用”保障。

* 事务内会额外删除其他用户安装记录，这是你期望的“删除后所有人都不能用”的语义。

