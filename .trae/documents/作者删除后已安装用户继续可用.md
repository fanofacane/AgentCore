## 目标
- 作者点击“删除Agent”后：
  - 该Agent从“已发布/可被新用户安装”入口消失（广场/已发布列表不可见，新增安装被拒绝）。
  - **已安装到工作区的用户仍能继续使用**（工作区仍可见，历史会话可继续访问）。

## 现状（只读确认）
- 当前作者删除会走物理语义的级联删除：删除 agents、agent_versions、agent_workspace 等，会导致其他用户被强制卸载。[AgentAppServiceImpl.deleteAgent](file:///d:/software/AgentCore/src/main/java/com/sky/AgentCore/service/agent/Impl/AgentAppServiceImpl.java#L200-L231)
- 工作区列表目前强依赖：`agents.enabled=true` 且版本必须是 `PUBLISHED` 才会展示。[AgentWorkspaceServiceImpl.getAgents](file:///d:/software/AgentCore/src/main/java/com/sky/AgentCore/service/agent/Impl/AgentWorkspaceServiceImpl.java#L44-L95)
- 广场/已发布列表只取 `PUBLISHED` 版本，并且也会过滤 `agents.enabled=true`。[AgentVersionServiceImpl.getPublishedAgentsByName](file:///d:/software/AgentCore/src/main/java/com/sky/AgentCore/service/agent/Impl/AgentVersionServiceImpl.java#L28-L38)

## 设计选择（符合你的要求）
- 将“作者删除”改为“下架并停用”而非级联清空：
  - **不删除 agent_workspace**（保留已安装关系），从而已安装用户仍可见/可用。
  - **Agent 设置为 disabled**（用于阻止新安装），但工作区列表对“已安装”放开 enabled 过滤。
  - **将已发布版本 publish_status 从 PUBLISHED 更新为 REMOVED**（从广场消失，且后续不再被当作可安装版本）。

## 具体改造点（待确认后实施）
1. **改造作者删除逻辑（核心）**
   - 修改 `AgentAppServiceImpl.deleteAgent(agentId, userId)`：
     - 保留 `scheduledTaskExecutionService.deleteTasksByAgentId(agentId, userId)`（只清作者任务）。
     - 不再 `remove(agents)`、不再 `remove(agent_versions/agent_workspace)`。
     - 改为：
       - 更新 `agents.enabled=false`（保留记录不走逻辑删除）。
       - 将该 agent 下所有 `publish_status=PUBLISHED` 的版本更新为 `REMOVED`（仅下架已发布版本）。
     - 作者自己的会话/追踪/消息是否清理：保持现状“只影响作者自己”，并把删除逻辑改为“可空删除不报错”。

2. **工作区列表支持“已安装但已下架/禁用”的Agent继续展示**
   - 修改 `AgentWorkspaceServiceImpl.getAgents(userId)`：
     - 取消对 `AgentEntity.enabled=true` 的强过滤（因为 installed 也要显示）。
     - 版本选择逻辑调整：对工作区已安装的 agentId，版本查询允许 `publish_status in (PUBLISHED, REMOVED)`：
       - 优先取最新 `PUBLISHED`；若不存在则取最新 `REMOVED`。
     - 返回的 `AgentDTO.enabled` 赋值为 `AgentEntity.enabled`，前端可据此展示“已下架/不可新装”。

3. **防止新安装（保持现有逻辑即可）**
   - `AgentWorkspaceServiceImpl.addAgent` 已调用 `agent.isEnable()`，作者删除后 `enabled=false` 会自然拒绝新增安装（无需额外改动）。

4. **广场/已发布列表保持不变（自然下架）**
   - `getPublishedAgentsByName` 仍只取 `PUBLISHED`，作者删除后已发布版本会被改为 `REMOVED`，因此自然不可见。

## 风险与兼容
- API 不新增字段：复用 `AgentDTO.enabled` 表达“已下架/禁用”。
- 兼容旧数据：即便历史版本被标为 REMOVED，系统仍可通过 `publishedVersion` 读取版本内容，不影响已安装用户使用。

## 验证点
- 作者删除后：
  - `/agents/published` 不再返回该 agent。
  - 其他已安装用户调用 `/agents/workspaces/agents` 仍能看到该 agent（enabled=false）。
  - 未安装用户调用 `/agents/workspaces/{agentId}` 添加时返回“助理未激活/不可添加”。
  - 已安装用户历史会话与对话流程不受影响。

如果你确认以上策略，我将按上述步骤开始改代码并补充最小验证用例。